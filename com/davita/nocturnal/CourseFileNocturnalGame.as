/*Copyright (c) 2012 Normal Software.  All rights reserved.  The copyrights embodied in the content of this file are licensed under the BSD (revised) open source license*/package com.davita.nocturnal{	import flash.display.*;	import flash.events.*;	import fl.motion.easing.*;	import flash.text.*;	import flash.media.SoundChannel;	import flash.media.Sound;	import flash.media.SoundLoaderContext;	import flash.media.SoundTransform;	import flash.media.SoundMixer;	import flash.net.URLRequest;	import flash.net.URLVariables;	import com.greensock.TimelineLite;	import com.greensock.TweenLite	import fl.controls.RadioButtonGroup;	import flash.utils.Timer;	import flash.utils.getTimer;	import com.davita.nocturnal.NocturnalAnimator;	import com.davita.events.*;	/**	 *  base class for davita standard game files.	 *	 * @langversion ActionScript 3	 * @playerversion Flash 9.0.0	 *	 * @author Dean Hawkey	 * @since  2012	 */	public dynamic class CourseFileNocturnalGame extends MovieClip 	{		// TODO: Move points into Nocturnal Wrapper		public var points:int = 25;		// TODO: Most of these variables can be moved or deleted		public var tf:TextFormat = new TextFormat("Arial",12,0xFFFFFF);		public var avatarLoader:Loader = new Loader();		public var restrictCorrect2one:Boolean = false;		public var restrictScore2oneClick:Boolean = false;		public var restrict2oneHintDeduction:Boolean = false;		private var closeSBTimer:Timer = new Timer(3000,1);		private var nextFrameTimer:Timer = new Timer(3500,1);		public var theAnimator = new NocturnalAnimator();		private var _pageMask:Sprite = new Sprite();		private var __courseWrapper:Object;		//---------------------------------------		// CONSTRUCTOR		//---------------------------------------		public function CourseFileNocturnalGame():void		{			if (stage)			{				init();			}			else			{				addEventListener(Event.ADDED_TO_STAGE, init);			}		}		//---------------------------------------		// PRIVATE METHODS		//---------------------------------------		private function init(e:Event = null):void		{			trace("CourseFileNocturnalGame::init()");;			maskPage();				        // find the wrapper and listen for a score updated event	        var success:Boolean = findWrapper();	        if(success)	        {	            __courseWrapper.addEventListener(ScoreUpdatedEvent.SCORE_UPDATED, updateScore, false, 0, true);	            dispatchEvent(new ScorePollEvent(ScorePollEvent.SCORE_POLLED));	        }					// TODO: implement scoring events			//dispatchEvent(new ScorePollEvent.SCORE_POLL);		}	    	    private function findWrapper():Boolean	    {	        var curParent:DisplayObjectContainer = this.parent;	        while (curParent) 	        { 	            if (curParent.hasOwnProperty("versionNumber") && curParent.hasOwnProperty("currentPage")) 	            { 	                __courseWrapper = curParent;	                trace("CourseFileNocturnalGame:: found the wrapper");	                return true;	                // Object(curParent).loader.addEventListener("unload", dispose, false, 0, true); 	            }	            curParent = curParent.parent;	        }	        trace("CourseFileNocturnalGame:: not in a wrapper");	        return false;	    }	    private function updateScore(event:ScoreUpdatedEvent):void	    {	        trace("CourseFileNocturnalGame::updateScore(" + event.toString() + ")");	        var theSuspendDataArray:Array = event.bookmarkMilesChallengesArray;	        this._bookmark = theSuspendDataArray[0];	        this._miles = theSuspendDataArray[1];	        this._challenges = theSuspendDataArray[2];	        //updateTextFields();	        scoreBoard_mc.open();	    }	    private function helpSetup():void	    {	        // Help Icon	        this.help_mc.visible = false;	        this.help_mc.buttonMode = true;			this.help_mc.useHandCursor = true;			this.help_mc.addEventListener(MouseEvent.CLICK, helpClose);			this.scoreBoard_mc.sbhelp_btn.addEventListener(MouseEvent.CLICK, helpOpen);	    }	    		private function maskPage():void		{			_pageMask.graphics.beginFill(0x000000);			_pageMask.graphics.drawRect(0,.5,1000,599.5);			addChild(_pageMask);			this.mask = _pageMask;		}		public function addPoints(addedPoints:int):void		{			scoreBoard_mc.open();			stage.addEventListener(Event.ENTER_FRAME, changeText);			trace("addPoints("+addedPoints+")");			points = (points + addedPoints);			trace("Total Points: " + points);			this.scoreBoard_mc.txtPoints.text = points.toString();		}		public function delayClose(e:TimerEvent)		{			scoreBoard_mc.close();		}		public function moveNext(e:TimerEvent)		{			nextFrame();		}		// SCORING   ------------------++++++++++++++++++		private function correctClick(event:MouseEvent):void		{			trace("correctClick");			var rightSound:Sound = new SFXcorrect();			rightSound.play();			this.theCensus_mc.gotoAndStop("Correct");			nextFrameTimer.addEventListener(TimerEvent.TIMER, moveNext);			nextFrameTimer.start();			if (restrictCorrect2one == false)			{				this.scoreBoard_mc.txtPoints.textColor = 0x00FF66;				restrictCorrect2one = true;				addPoints(5);				var closeSBTimer:Timer = new Timer(3000,1);				closeSBTimer.addEventListener(TimerEvent.TIMER, delayClose);				closeSBTimer.start();				restrict2oneHintDeduction = true;			}			else			{				restrictScore2oneClick = true;				trace("Already added to score, not doing it again.");			}		}		private function correctInit():void		{			correctButton_mc.addEventListener(MouseEvent.CLICK, correctClick);			correctButton_mc.buttonMode = true;			correctButton_mc.useHandCursor = true;			restrictScore2oneClick = false;			restrictCorrect2one = false;		}		private function IncorrectInit():void		{			incorrectButton_mc.addEventListener(MouseEvent.CLICK, incorrectClick);			incorrectButton_mc.buttonMode = true;			incorrectButton_mc.useHandCursor = true;		}		private function incorrectClick(event:MouseEvent):void		{			var wrongSound:Sound = new SFXwrong();			wrongSound.play();			trace("Incorrect Click");			if (restrictScore2oneClick == false)			{				this.scoreBoard_mc.txtPoints.textColor = 0xFF0000;				restrictScore2oneClick = true;				addPoints(-5);				this.theCensus_mc.gotoAndStop("Incorrect");				var closeSBTimer:Timer = new Timer(3000,1);				closeSBTimer.addEventListener(TimerEvent.TIMER, delayClose);				closeSBTimer.start();			}			else			{				this.theCensus_mc.gotoAndStop("Incorrect2");				trace("Already deducted score, not doing it again.");			}		}				// Make sure text changes		public function changeText(evt:Event)		{			this.scoreBoard_mc.txtPoints.text = points.toString();			stage.removeEventListener(Event.ENTER_FRAME, changeText);		}		// HELP FUNCTIONS		private function helpClose(event:MouseEvent):void		{			this.help_mc.visible = false;		}		public function helpOpen(event:MouseEvent):void		{			this.help_mc.visible = true;			var timeline:TimelineLite = new TimelineLite();			timeline.append(TweenLite.from(this.help_mc, 1, {alpha:0}));			timeline.append(TweenLite.to(this.help_mc, 1, {alpha:1}));		}		// [*********************** Avatar/Census Functions **********************]		// AvatarPositions				public function LoadAvaInPos(xPos,yPos,avatarLoader):void		{			// Align			addChild(avatarLoader);			avatarLoader.x = xPos;			avatarLoader.y = yPos;			avatarLoader.name = "Avatar";			//avatarLoader.content.msPlay('Message 1');		}		public function avatarPreloader()		{			// Start Pre-Loader			addChild(avatarLoading);			avatarLoading.x = 500;			avatarLoading.y = 300;		}		public function removeAvatar():void		{			removeChild(getChildByName("Avatar"));			SoundMixer.stopAll();		}		}}